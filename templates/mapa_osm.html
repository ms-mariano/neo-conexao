<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neoconexão</title>
    
    <link rel="stylesheet" href="../static/css/style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Estilos para a página do mapa */
        .map-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-box input {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .search-box button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-box button:hover {
            background: #0056b3;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .coordinates-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .result-item {
            margin: 5px 0;
            font-family: monospace;
        }
        
        .copy-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .success {
            color: #155724;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <button class="menu-btn">☰</button>
            <ul class="menu">
                <li><a href="/"> Início </a></li>
                <li><a href="/sobre"> Sobre </a></li>
                <li><a href="/blog"> Blog </a></li>
                <li><a href="/login"> Login </a></li>
                <li><a href="/divulgacao_escolas"> Escolas </a></li>
                <li><a href="/vagas"> Vagas </a></li>
                <li><a href="/cursos"> Cursos </a></li>
                <li><a href="/mapa"> Mapa</a></li>
            </ul>
        </nav>
    </header>

    <main class="map-container">
        <h1>Mapa de Localização</h1>
        
        <div class="search-box">
            <input type="text" id="addressInput" 
                   placeholder="Ex: Avenida Paulista, 1000, São Paulo, SP" 
                   value="Avenida Paulista, São Paulo">
            <button onclick="searchAddress()">Buscar no Mapa</button>
            <button onclick="locateMe()">Minha Localização</button>
        </div>
        
        <div id="message"></div>
        
        <div id="map"></div>
        
        <div id="coordinatesResult" class="coordinates-info" style="display: none;">
            <h3>Informações da Localização:</h3>
            <div class="result-item" id="resultAddress"></div>
            <div class="result-item" id="resultCoords"></div>
            <button class="copy-btn" onclick="copyCoordinates()">Copiar Coordenadas</button>
        </div>
    </main>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Inicializar o mapa
        const map = L.map('map').setView([-23.5505, -46.6333], 10); // Centro em São Paulo
        
        // Adicionar camada do mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        let currentMarker = null;
        let currentLocation = null;

        // Função de geocoding
        async function geocodeAddress(address) {
            try {
                showMessage('Buscando endereço...', 'info');
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`
                );
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        latitude: parseFloat(data[0].lat),
                        longitude: parseFloat(data[0].lon),
                        address: data[0].display_name,
                        details: data[0]
                    };
                } else {
                    throw new Error('Endereço não encontrado');
                }
            } catch (error) {
                console.error('Erro no geocoding:', error);
                showMessage('Erro ao buscar endereço: ' + error.message, 'error');
                return null;
            }
        }

        // Função principal de busca
        async function searchAddress() {
            const address = document.getElementById('addressInput').value.trim();
            
            if (!address) {
                showMessage('Por favor, digite um endereço', 'error');
                return;
            }

            const result = await geocodeAddress(address);
            
            if (result) {
                showLocationOnMap(result);
                showCoordinatesResult(result);
                showMessage('Localização encontrada com sucesso!', 'success');
            }
        }

        // Mostrar localização no mapa
        function showLocationOnMap(location) {
            const { latitude, longitude, address } = location;
            
            // Remover marcador anterior se existir
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Adicionar novo marcador
            currentMarker = L.marker([latitude, longitude])
                .addTo(map)
                .bindPopup(`
                    <strong>${address}</strong><br>
                    Lat: ${latitude}<br>
                    Lng: ${longitude}
                `)
                .openPopup();
            
            // Centralizar mapa na localização
            map.setView([latitude, longitude], 15);
            
            currentLocation = location;
        }

        // Mostrar resultados das coordenadas
        function showCoordinatesResult(location) {
            const resultDiv = document.getElementById('coordinatesResult');
            const addressElement = document.getElementById('resultAddress');
            const coordsElement = document.getElementById('resultCoords');
            
            addressElement.innerHTML = `<strong>Endereço:</strong> ${location.address}`;
            coordsElement.innerHTML = `<strong>Coordenadas:</strong> ${location.latitude}, ${location.longitude}`;
            
            resultDiv.style.display = 'block';
        }

        // Função para localização atual
        function locateMe() {
            if (!navigator.geolocation) {
                showMessage('Geolocalização não é suportada pelo seu navegador', 'error');
                return;
            }
            
            showMessage('Obtendo sua localização...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        address: 'Sua localização atual'
                    };
                    
                    showLocationOnMap(location);
                    showCoordinatesResult(location);
                    showMessage('Localização atual encontrada!', 'success');
                    
                    // Atualizar campo de endereço
                    reverseGeocode(position.coords.latitude, position.coords.longitude);
                },
                function(error) {
                    let message = 'Erro ao obter localização: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permissão negada pelo usuário';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Localização indisponível';
                            break;
                        case error.TIMEOUT:
                            message += 'Tempo de espera excedido';
                            break;
                        default:
                            message += 'Erro desconhecido';
                    }
                    showMessage(message, 'error');
                }
            );
        }

        // Reverse geocoding (coordenadas para endereço)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
                );
                
                const data = await response.json();
                
                if (data && data.display_name) {
                    document.getElementById('addressInput').value = data.display_name;
                    if (currentLocation) {
                        currentLocation.address = data.display_name;
                        showCoordinatesResult(currentLocation);
                    }
                }
            } catch (error) {
                console.error('Erro no reverse geocoding:', error);
            }
        }

        // Copiar coordenadas para área de transferência
        function copyCoordinates() {
            if (currentLocation) {
                const coords = `${currentLocation.latitude}, ${currentLocation.longitude}`;
                navigator.clipboard.writeText(coords)
                    .then(() => {
                        showMessage('Coordenadas copiadas para a área de transferência!', 'success');
                    })
                    .catch(err => {
                        showMessage('Erro ao copiar coordenadas', 'error');
                    });
            }
        }

        // Mostrar mensagens para o usuário
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${message}</div>`;
            
            // Auto-remover mensagem após 5 segundos
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Buscar ao pressionar Enter
        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        });

        // Exemplo de uso inicial
        window.addEventListener('load', function() {
            // Buscar localização inicial
            searchAddress();
        });
    </script>
</body>
</html>